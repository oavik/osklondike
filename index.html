<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>Klondike</title>
<style type="text/css">
body { background: darkgreen; }

div { padding: 0; display: inline-block; }
#upper { height: 16em; }
#upper div { display: inline-block; }

#deck { width: 6em; height: 8em; position: fixed; top: 0.5em; left: .5em; }
#deck .card { position: inherit; }

#waste .card { position: fixed; top: 0.5em; }
#waste :nth-last-child(3n+3) { left: 7.5em; z-index: -1; }
#waste :nth-last-child(3n+2) { left: 9.0em; z-index: 0; }
#waste :nth-last-child(3n+1) { left: 10.5em; z-index: 1; }

#foundation { position: fixed; right: 0.5em; }
#foundation > div { display: inline-block; width: 6em; height: 8em; border: thin solid black; margin-left: 1em; padding: 0; margin-top: 0; }
#foundation .card { position: absolute; }

#tableau { position: absolute; top: 9em; width: 100%; }
#tableau > div { width: 13%; height: 8em; display: inline-block; vertical-align: top; text-align: center; }
#tableau > div + div { margin-left: 1%; }
#tableau > div > .card + .card { position: relative; margin-top: -7em; }

.card { background: white; width: 6em; height: 8em; border: thin solid black; }
.card span { display: inline-block; height: 8em; padding: 0.1em; }
.card .face { width: 4em; white-space: pre; text-align: center; vertical-align: middle; font-size: larger; }
.card .top { float: left; vertical-align: top; }
.card .bottom { float: right; vertical-align: top; visibility: hidden; }
.facedown { background: blue; border: thin solid white;}
.clubs, .spades { color: black; }
.hearts, .diams { color: red; }
</style>
<script type="text/javascript">
var suits = [ "hearts", "clubs", "diams", "spades" ];
var values = [ "A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K" ];
var faces = [
	"x",
	"x<br>x",
	"x<br>x<br>x",
	"x x<br>x x",
	"x x<br> x <br>x x",
	"x x<br>x x<br>x x",
	"x x<br> x <br>x x<br>x x<br>x x",
	"x x<br> x <br>x x<br> x <br>x x",
	"x x<br>x x<br> x <br>x x<br>x x",
	"x x<br> x <br>x x<br>x x<br> x <br>x x",
	"<!-- J -->", "<!-- Q -->", "<!-- K -->"
];

function movetofoundation(e) {
	var f = document.getElementById("foundation");
	for (var i = 3; i >= 0; i--) {
		if (f.childNodes[i].childNodes.length == this.value && (this.value == 0 || this.suit == f.childNodes[i].lastChild.suit)) {
			this.moveto(f.childNodes[i], "foundation");
		}
	}
}

function canmove(from, to) {
	if ((to.location == "foundation" && from.nextSibling == undefined) && (from.value == 0) || (from.value == to.value + 1 && from.suit == to.suit)) {
		return true;
	}
	if (to.location == "tableau" && from.value == to.value - 1 && (from.suit - to.suit) % 2 != 0) {
		return true;
	}
	return false;
}

function dragstart(e) {
	e.dataTransfer.setData("Text", e.target.id);
	window.dragging = e.target;
}

function drop(e) {
	e.preventDefault();
	var card = document.getElementById(e.dataTransfer.getData("Text"));
	var target = e.target;
	if (target.className == "" && target.parentNode.id == "foundation") {
		if (card.value == 0) {
			card.moveto(target, "foundation");
		}
		return;
	} else if (target.className == "" && target.parentNode.id == "tableau") {
		if (card.value == values.length - 1) {
			card.moveto(target, "tableau");
		}
		return;
	}
	while (!target.className.includes("card")) {
		target = target.parentNode;
	}
	if (canmove(card, target)) {
		card.moveto(target.parentNode, target.location);
	}
}

function dragover(e) {
	e.preventDefault();
}

var Card = function(suit, value) {
	var c = document.createElement("div");
	c.id = suits[suit] + "-" + values[value];
	c.suit = suit;
	c.value = value;
	c.draggable = false;
	c.faceup = true;
	c.location = "deck";
	c.setmovable = function(movable) {
		if (movable) {
			this.draggable = true;
			this.addEventListener("click", movetofoundation);
			this.addEventListener("dragstart", dragstart, false);
			this.addEventListener("drop", drop, false);
			this.addEventListener("dragover", dragover, false);
		} else {
			this.draggable = false;
			this.removeEventListener("click", movetofoundation);
			this.removeEventListener("dragstart", dragstart, false);
			this.removeEventListener("drop", drop, false);
			this.removeEventListener("dragover", dragover, false);
		}
	};
	c.moveto = function(to, loc) {
			var from = this.parentNode;
			var next = this.nextSibling;
			if (this.previousSibling && this.previousSibling.faceup == false) {
				this.previousSibling.flip();
			} else if (this.previousSibling && this.previousSibling.faceup == true) {
				this.previousSibling.setmovable(true);
			}
			from.removeChild(this);
			to.appendChild(this);
			this.location = loc;
			if (next != undefined) {
				next.moveto(this.parentNode, loc);
			}
	};
	c.flip = function() {
		this.faceup = !this.faceup;
		if (this.faceup) {
			this.className = "card " + suits[this.suit];
			this.innerHTML = '<span class="top">' + values[this.value] + "<br>&" + suits[this.suit] + ';</span><span class="face">' +
				faces[this.value].replace(/x/g, "&" + suits[this.suit] + ";") + '<br></span><span class="bottom">' +
				values[this.value] + "<br>&" + suits[this.suit] + ";</span>";
			this.setmovable(true);
		} else {
			this.className = "card facedown";
			this.innerHTML = "";
			this.setmovable(false);
		}
	};
	c.flip();
	return c;
};

function draw(e) {
	e.preventDefault();
	var deck = document.getElementById("deck");
	var waste = document.getElementById("waste");
	if (waste.childNodes.length > 0) {
		waste.lastChild.setmovable(false);
	}

	if (deck.childNodes.length == 0) {
		while (waste.childNodes.length > 0) {
			var c = waste.lastChild;
			waste.removeChild(c);
			c.flip();
			deck.appendChild(c);
		}
	}

	for (var i = 0; i < 3; i++) {
		if (deck.childNodes.length > 0) {
			var c = deck.lastChild;
			deck.removeChild(c);
			c.flip();
			c.setmovable(false);
			waste.appendChild(c);
		}
	}

	waste.lastChild.setmovable(true);
}

function init() {
	var cards = new Array();
	for (var s = 0; s < suits.length; s++) {
		for (var v = 0; v < values.length; v++) {
			cards.push(new Card(s, v));
		}
	}

	var deck = document.getElementById("deck");
	while (cards.length > 0) {
		var card = Math.floor(Math.random() * cards.length);
		deck.appendChild(cards[card]);
		cards.splice(card, 1);
	}
	deck.addEventListener("click", draw);

	var tableau = document.getElementById("tableau");
	for (var t = 0; t < 7; t++) {
		tableau.childNodes[t].addEventListener("dragover", dragover);
		tableau.childNodes[t].addEventListener("drop", drop);
		for (var c = 6 - t; c < 7; c++) {
			var card = deck.lastChild;
			deck.removeChild(card);
			tableau.childNodes[t].appendChild(card);
			card.location = "tableau";
		}
		tableau.childNodes[t].lastChild.flip();
	}

	var foundation = document.getElementById("foundation");
	for (var f = 0; f < 4; f++) {
		foundation.childNodes[f].addEventListener("dragover", dragover);
		foundation.childNodes[f].addEventListener("drop", drop);
	}
}

</script>
</head>
<body onload="init();">
<div id="deck"></div>
<div id="waste"></div>
<div id="foundation"><div></div><div></div><div></div><div></div></div>
<div id="tableau"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
</body>
</html>
