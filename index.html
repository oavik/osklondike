<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>Klondike</title>
<style type="text/css">
body { background: darkgreen; }

span { margin: 0; padding: 0; }
div { padding: 0; }
#upper { height: 240px; }
#upper div { display: inline-block; }

#deck { width: 100px; height: 120px; }
#deck .card { position: absolute; top: 0; left: 0; }

#waste { width: 200px; height: 120px; }
#waste .card { position: absolute; top: 0; }

#foundation { float: right; } 
#foundation div { width: 100px; height: 120px; border: thin solid black; padding-left: 10px; }
#foundation .card { position: relative; top: 0; }

#tableau { width: 770px; height: 120px; }
#tableau div { width: 100px; display: inline-block; padding-left: 10px; vertical-align: top; }

.card { background: white; width: 100px; height: 120px; display: inline-block; border: thin solid black; }
.facedown { background: blue; border: thin solid white;}
.clubs, .spades { color: black; }
.hearts, .diams { color: red; }
</style>
<script type="text/javascript">
var suits = [ "hearts", "clubs", "diams", "spades" ];
var values = [ "A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K" ];

function movetofoundation(e) {
	var f = document.getElementById("foundation");
	for (var i = 0; i < 4; i++) {
		if (f.childNodes[i].childNodes.length == this.value && (this.value == 0 || this.suit == f.childNodes[i].lastChild.suit)) {
			this.moveto(f.childNodes[i]);
		}
	}
}

function canmove(from, to) {
	if (to.location == "foundation" && from.value == to.value + 1 && from.suit == to.suit) {
		return true;
	}
	if (to.location == "tableau" && from.value == to.value - 1 && (from.suit - to.suit) % 2 != 0) {
		return true;
	}
	return false;
}

function dragstart(e) {
	e.dataTransfer.setData("Text", e.target.id);
	window.dragging = e.target;
}

function drop(e) {
	e.preventDefault();
	var card = document.getElementById(e.dataTransfer.getData("Text"));
	if (canmove(card, e.target)) {
		card.moveto(e.target.parentNode);
	}
}

function dragover(e) {
	e.preventDefault();
	//e.returnValue = canmove(window.dragging, e.target);
}

var Card = function(suit, value) {
	var c = document.createElement("div");
	c.id = suits[suit] + "-" + values[value];
	c.suit = suit;
	c.value = value;
	c.draggable = false;
	c.faceup = true;
	c.location = "deck";
	c.moveto = function(to) {
			var from = this.parentNode;
			if (this.previousSibling && this.previousSibling.faceup == false) {
				this.previousSibling.flip();
			}
			from.removeChild(this);
			to.appendChild(this);
	}
	c.flip = function() {
		this.faceup = !this.faceup;
		if (this.faceup) {
			this.className = "card " + suits[this.suit];
			this.innerHTML = values[this.value] + "<br>&" + suits[this.suit] +";";
			this.draggable = true;
			this.addEventListener("click", movetofoundation);
			this.addEventListener("dragstart", dragstart);
			this.addEventListener("drop", drop);
			this.addEventListener("dragover", dragover);
		} else {
			this.className = "card facedown";
			this.innerHTML = "";
			this.draggable = false;
			this.removeEventListener("click", movetofoundation);
		}
	};
	c.flip();
	return c;
};

function draw(e) {
	e.preventDefault();
	var deck = document.getElementById("deck");
	var waste = document.getElementById("waste");

	if (deck.childNodes.length == 0) {
		while (waste.childNodes.length > 0) {
			var c = waste.lastChild;
			waste.removeChild(c);
			c.flip();
			c.style.marginLeft = 0;
			deck.appendChild(c);
		}
	}

	for (var i = 0; i < 3; i++) {
		if (deck.childNodes.length > 0) {
			var c = deck.lastChild;
			deck.removeChild(c);
			c.flip();
			c.style.marginLeft = i * 1 + "em";
			waste.appendChild(c);
		}
	}
}

function init() {
	var cards = new Array();
	for (var s = 0; s < suits.length; s++) {
		for (var v = 0; v < values.length; v++) {
			cards.push(new Card(s, v));
		}
	}

	for (var i = 0; i < 4; i++) {
		for (var j = 0; j < 4; j++) {
			console.log(suits[i] + "/" + suits[j] + "=" + ((i - j) % 2));
		}
	}

	var deck = document.getElementById("deck");
	while (cards.length > 0) {
		var card = Math.floor(Math.random() * cards.length);
		deck.appendChild(cards[card]);
		cards.splice(card, 1);
	}
	deck.addEventListener("click", draw);

	var tableau = document.getElementById("tableau");
	for (var t = 0; t < 7; t++) {
		for (var c = 6 - t; c < 7; c++) {
			var card = deck.lastChild;
			deck.removeChild(card);
			tableau.childNodes[t].appendChild(card);
			card.style.marginTop = "-100px";
		}
		tableau.childNodes[t].lastChild.flip();
	}
}

</script>
</head>
<body onload="init();">
<div id="upper">
	<div id="deck"></div>
	<div id="waste"></div>
	<div id="foundation"><div></div><div></div><div></div><div></div></div>
</div>
<div id="tableau"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
</body>
</html>
